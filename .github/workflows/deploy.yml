name: Deploy Next.js to GitHub Pages

on:
  push:
    branches:
      - next
  repository_dispatch:
    types: [youchat-updated]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for pushing to another branch

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js static site
        run: npm run build # This will output static files to 'out' with output: 'export' in next.config.ts

      # Checkout and build youchat (Vista)
      - name: Checkout youchat repository
        uses: actions/checkout@v4
        with:
          repository: skjapps/youchat
          token: ${{ secrets.GH_PAT }}
          path: youchat-temp

      - name: Install youchat dependencies
        run: |
          cd youchat-temp
          npm ci

      - name: Build youchat static site with basePath
        run: |
          cd youchat-temp
          # Temporarily update next.config.ts to add basePath
          node -e "
            const fs = require('fs');
            const config = fs.readFileSync('next.config.ts', 'utf8');
            const updated = config.replace(
              'const nextConfig: NextConfig = {',
              'const nextConfig: NextConfig = {\n  basePath: \"/vista\",\n  assetPrefix: \"/vista\",'
            );
            fs.writeFileSync('next.config.ts', updated);
          "
          npm run build

      - name: Copy youchat build to main out directory
        run: |
          mkdir -p ./out/vista
          cp -r youchat-temp/out/* ./out/vista/
          # Copy public assets (images, etc.) that Next.js static export includes
          # Next.js already copies public folder contents during build, but we ensure all assets are present
          if [ -d "youchat-temp/public" ]; then
            echo "Copying public assets from youchat..."
            # The public folder contents should already be in out, but we'll verify the assets folder
            if [ ! -d "./out/vista/assets" ] && [ -d "youchat-temp/public/assets" ]; then
              cp -r youchat-temp/public/assets ./out/vista/
            fi
          fi

      - name: Deploy to main branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GH_PAT }}
          publish_dir: ./out
          publish_branch: main